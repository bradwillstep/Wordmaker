<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Wordmaker</title>
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#0b0f14">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css">
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#0f1620;
      --panel2:#111b27;
      --text:#e7eef7;
      --muted:rgba(231,238,247,.78);
      --border:rgba(255,255,255,.14);
      --btn:#121b26;
      --btnBorder:rgba(255,255,255,.18);
      --accent:#ff6bd6;
      --headerH: 112px;
    }
    html,body{height:100%;}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);background:var(--bg);overflow-x:hidden;}
    body::before{content:"";position:fixed;inset:8px;border-radius:22px;pointer-events:none;z-index:900;border:2px solid color-mix(in srgb, var(--accent) 65%, rgba(255,255,255,.12));box-shadow:0 0 0 6px rgba(0,0,0,.22),0 18px 60px rgba(0,0,0,.35);background:linear-gradient(180deg, color-mix(in srgb, var(--accent) 18%, transparent), transparent) padding-box;}
    body::after{content:"";position:fixed;inset:14px;border-radius:18px;pointer-events:none;z-index:899;opacity:.6;background:repeating-linear-gradient(135deg,color-mix(in srgb, var(--accent) 18%, transparent) 0 10px,rgba(0,0,0,0) 10px 22px);mix-blend-mode:screen;}
    header{position:fixed;top:0;left:0;right:0;z-index:1000;background:color-mix(in srgb, var(--bg) 88%, rgba(255,255,255,.03));border-bottom:1px solid rgba(255,255,255,.10);backdrop-filter:blur(10px);padding:6px 8px;}
    .wrap{max-width:1180px;margin:0 auto;}
    .bar{display:flex;flex-wrap:wrap;gap:6px;align-items:center;justify-content:space-between;}
    .left,.right{display:flex;flex-wrap:wrap;gap:6px;align-items:center;}
    input,select,textarea{background:var(--btn);color:var(--text);border:1px solid var(--btnBorder);border-radius:10px;padding:6px 8px;font-size:13px;outline:none;font-family:inherit;}
    button{background:var(--btn);color:var(--text);border:1px solid var(--btnBorder);border-radius:10px;padding:6px 8px;font-size:13px;cursor:pointer;-webkit-tap-highlight-color:transparent;}
    button:disabled{opacity:.55;cursor:not-allowed}
    .chip{font-size:11px;border:1px solid var(--btnBorder);padding:4px 8px;border-radius:999px;opacity:.92;background:rgba(255,255,255,.04)}
    .status{margin-top:6px;font-size:12px;opacity:.85;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;white-space:pre-wrap}
    main{max-width:1180px;margin:0 auto;padding:calc(var(--headerH) + 14px) 14px 18px;}
    .ql-toolbar.ql-snow{border-radius:14px 14px 0 0;border:1px solid var(--border);background:color-mix(in srgb, var(--panel) 86%, rgba(255,255,255,.06));}
    .ql-container.ql-snow{border-radius:0 0 14px 14px;border:1px solid var(--border);border-top:0;background:color-mix(in srgb, var(--panel) 94%, rgba(255,255,255,.03));}
    .ql-editor{min-height:calc(100vh - var(--headerH) - 170px);padding:18px 16px 80px;font-size:16px;line-height:1.5;color:var(--text);background-image:linear-gradient(to bottom,rgba(255,255,255,0) calc(1120px - 2px),rgba(255,255,255,.14) calc(1120px - 2px),rgba(255,255,255,.14) 1120px);background-size:100% 1120px;background-repeat:repeat;}
    .installFab{position:fixed;bottom:calc(env(safe-area-inset-bottom,0px) + 16px);right:16px;width:44px;height:44px;border-radius:999px;border:1px solid rgba(255,255,255,.22);background:color-mix(in srgb, var(--btn) 80%, rgba(255,255,255,.08));box-shadow:0 18px 40px rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:8000}
    .installFab svg{width:22px;height:22px;opacity:.95}
    .calcMenu{position:fixed;right:10px;top:calc(var(--headerH) - 6px);width:min(420px, calc(100vw - 20px));background:var(--panel2);border:1px solid var(--border);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.55);padding:10px;display:none;z-index:8500}
    .calcGrid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:10px}
    .calcGrid button{padding:10px 0;border-radius:12px}
    .calcOut{margin-top:8px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;font-size:12px;white-space:pre-wrap;opacity:.9}
    .divider{height:1px;background:rgba(255,255,255,.12);margin:10px 0}
    .tapOverlay{position:fixed;inset:calc(var(--headerH) + 8px) 10px 10px 10px;display:flex;align-items:center;justify-content:center;z-index:2000;pointer-events:none}
    .tapCard{pointer-events:auto;background:color-mix(in srgb, var(--panel) 88%, rgba(255,255,255,.06));border:2px dashed var(--accent);border-radius:20px;padding:22px 18px;max-width:min(520px, 90vw);text-align:center;box-shadow:0 20px 50px rgba(0,0,0,.45)}
    .tapCard h2{margin:0 0 8px;font-size:20px}
    .tapCard p{margin:0;opacity:.9;font-size:14px}
    .drawerBack{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;z-index:9000}
    .drawer{position:fixed;right:0;top:0;height:100%;width:min(620px,96vw);background:var(--panel);border-left:1px solid var(--border);display:none;z-index:9001;overflow:auto}
    .drawerHead{position:sticky;top:0;display:flex;justify-content:space-between;align-items:center;gap:8px;padding:10px;border-bottom:1px solid var(--border);background:color-mix(in srgb, var(--panel) 86%, rgba(255,255,255,.06))}
    .drawerBody{padding:10px}
    .section{border:1px solid var(--border);border-radius:14px;padding:10px;background:rgba(255,255,255,.02);margin-bottom:10px}
    .section h3{margin:0 0 8px;font-size:13px}
    .small{font-size:12px;opacity:.82;line-height:1.35}
    iframe{width:100%;height:520px;border:1px solid var(--border);border-radius:14px;background:rgba(0,0,0,.2)}
  </style>
</head>
<body>
  <div id="installFab" class="installFab" title="Install Wordmaker" aria-label="Install Wordmaker">
    <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M12 3v10" stroke="white" stroke-width="2" stroke-linecap="round"/>
      <path d="M8 11l4 4 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M5 21h14" stroke="white" stroke-width="2" stroke-linecap="round"/>
    </svg>
  </div>

  <div class="tapOverlay" id="tapOverlay">
    <div class="tapCard">
      <h2>Tap here to start typing ‚ú®</h2>
      <p>This works like Microsoft Word ‚Äî just tap the page and begin.</p>
    </div>
  </div>

  <header id="hdr">
    <div class="wrap">
      <div class="bar">
        <div class="left">
          <input id="docTitle" type="text" value="Wordmaker document" />
          <button id="btnNew">New</button>
          <button id="btnSave">Save</button>
          <button id="btnOpen">Open</button>
          <input id="fileOpen" type="file" accept=".html,.txt,.docx,.rtf,.pdf,.odt,.pages,.doc,application/pdf,application/vnd.oasis.opendocument.text,application/vnd.apple.pages,text/plain,text/rtf,text/html,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" style="display:none" />
        </div>
        <div class="right">
          <select id="skinSel">
            <option value="bunny" selected>üê∞ Bunny</option>
            <option value="shark">ü¶à Shark</option>
            <option value="tiger">üêØ Tiger</option>
            <option value="zebra">ü¶ì Zebra</option>
            <option value="lion">ü¶Å Lion</option>
            <option value="cat">üê± Cat</option>
            <option value="dog">üê∂ Dog</option>
          </select>
          <button id="btnCalc">Calculator ‚ñæ</button>
          <button id="btnPageMode">Page Mode: OFF</button>
          <button id="btnDocx">Export DOCX</button>
          <button id="btnPdf">Export PDF</button>
          <button id="btnPrint">Print</button>
          <button id="btnTools">Tools</button>
        </div>
      </div>
      <div class="bar" style="margin-top:6px;">
        <div class="left" style="flex:1;">
          <input id="headerText" type="text" placeholder="Header (print/PDF)" style="flex:1;min-width:160px;" />
          <input id="footerText" type="text" placeholder="Footer (print/PDF)" style="flex:1;min-width:160px;" />
        </div>
        <div class="right">
          <span class="chip">Wordmaker</span>
          <span class="chip">PWA</span>
          <span class="chip">Open-any-file (best-effort)</span>
        </div>
      </div>
      <div class="status" id="status">Status: starting‚Ä¶</div>
    </div>
  </header>

  <div class="calcMenu" id="calcMenu">
    <div class="small"><b>Calculator</b></div>
    <input id="calcDisplay" type="text" placeholder="Expression: (24*3)+7/2" style="width:100%;" />
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
      <button id="calcEval">=</button>
      <button id="calcClear">C</button>
      <button id="calcBack">‚å´</button>
      <button id="calcAISolve">AI Solve</button>
    </div>
    <div class="calcGrid" id="calcKeys"></div>
    <div class="divider"></div>
    <div class="small">Paste a word problem:</div>
    <textarea id="calcProblem" rows="4" style="width:100%;min-height:86px;resize:vertical;margin-top:8px;"></textarea>
    <button id="calcAISolve2" style="margin-top:8px;width:100%;">AI Solve Problem</button>
    <div class="divider"></div>
    <div class="small"><b>AI Mode</b> (open-source)</div>
    <select id="aiModeSelect" style="width:100%;margin-top:6px;">
      <option value="fast" selected>Fast (WebLLM Qwen2.5-Math 1.5B)</option>
      <option value="max">Max Accuracy (GGUF via wllama)</option>
    </select>
    <div id="maxModeBox" style="display:none;margin-top:8px;">
      <div class="small" style="margin-bottom:6px;">GGUF URL (desktop recommended)</div>
      <input id="ggufUrl" type="text" style="width:100%;" value="https://github.com/bradwillstep/Wordmaker/releases/download/v1/Qwen2.5-Math-7B-Instruct.Q4_K_M.gguf" />
      <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
        <button id="btnLoadGGUF">Load 7B Model</button>
        <span class="small" id="ggufStatus">Not loaded</span>
      </div>
    </div>
    <div class="calcOut" id="calcOut"></div>
  </div>

  <main>
    <div id="toolbar">
      <select class="ql-header"><option selected></option><option value="1">H1</option><option value="2">H2</option><option value="3">H3</option></select>
      <button class="ql-bold"></button><button class="ql-italic"></button><button class="ql-underline"></button>
      <select class="ql-color"></select><select class="ql-background"></select>
      <button class="ql-blockquote"></button>
      <button class="ql-list" value="ordered"></button>
      <button class="ql-list" value="bullet"></button>
      <button class="ql-indent" value="-1"></button>
      <button class="ql-indent" value="+1"></button>
      <button class="ql-link"></button>
      <button class="ql-clean"></button>
    </div>
    <div id="editor"></div>
    <div id="pagesHost" style="display:none; max-width:900px; margin:14px auto 0;"></div>
  </main>

  <div class="drawerBack" id="drawerBack"></div>
  <aside class="drawer" id="drawer">
    <div class="drawerHead">
      <strong>Tools</strong>
      <button id="btnCloseTools">Close</button>
    </div>
    <div class="drawerBody">
      <div class="section">
        <h3>Embedded AI panel (no key)</h3>
        <div class="small">Copy selection ‚Üí paste into the panel ‚Üí paste output ‚Üí insert.</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
          <button id="btnCopySelection">Copy Selection</button>
          <button id="btnCopyAll">Copy Document</button>
          <button id="btnOpenEmbed">Open AI in new tab</button>
        </div>
        <textarea id="embedResult" style="width:100%;min-height:90px;margin-top:8px;" placeholder="Paste AI output here‚Ä¶"></textarea>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
          <button id="btnReplaceWithEmbed">Replace Selection</button>
          <button id="btnInsertEmbed">Insert at Cursor</button>
        </div>
        <div style="margin-top:10px;">
          <iframe id="embedFrame" title="Embedded AI Space"></iframe>
        </div>
      </div>

      <div class="section">
        <h3>Grammar checker (free)</h3>
        <div class="small">LanguageTool public endpoint (may rate-limit).</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
          <button id="btnGrammar">Check Grammar</button>
          <button id="btnClearIssues">Clear</button>
        </div>
        <div id="issues" style="margin-top:8px;"></div>
      </div>

      <div class="section">
        <h3>Optional AI writing (BYO key)</h3>
        <div class="small">Optional, not required for calculator AI.</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;">
          <input id="apiBase" type="text" value="https://api.openai.com/v1/responses" />
          <input id="apiModel" type="text" value="gpt-4.1-mini" />
        </div>
        <input id="apiKey" type="password" placeholder="Paste API key (optional)" style="width:100%;margin-top:8px;" />
        <textarea id="aiInstruction" style="min-height:90px;margin-top:8px;">Rewrite the selected text to be clearer and more professional while keeping the meaning. Preserve names and facts. Return only the rewritten text.</textarea>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
          <button id="btnRewrite" disabled>Rewrite</button>
          <button id="btnExpand" disabled>Expand</button>
          <button id="btnSumm" disabled>Summarize</button>
          <button id="btnInsert" disabled>Continue</button>
          <button id="btnSaveKey">Save Key</button>
          <button id="btnForgetKey">Forget Key</button>
        </div>
        <div class="small" id="aiNote" style="margin-top:8px;">AI writing disabled (optional).</div>
      </div>
    </div>
  </aside>

  <script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html-docx-js@0.3.1/dist/html-docx.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fflate@0.8.2/umd/index.js"></script>

  <script>
    if ("serviceWorker" in navigator) navigator.serviceWorker.register("./sw.js").catch(()=>{});
    if (window.pdfjsLib) pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
  </script>

  <script type="module">
    const $ = (id) => document.getElementById(id);
    function setStatus(s){ $("status").textContent = "Status: " + s; }

    const hdr = $("hdr");
    function updateHeaderH(){
      document.documentElement.style.setProperty("--headerH", Math.round(hdr.getBoundingClientRect().height) + "px");
    }
    window.addEventListener("resize", updateHeaderH);
    window.addEventListener("orientationchange", updateHeaderH);

    const tapOverlay = $("tapOverlay");
    function hideOverlay(){
      if (!tapOverlay) return;
      tapOverlay.style.display = "none";
      document.removeEventListener("keydown", hideOverlay);
    }
    document.addEventListener("keydown", hideOverlay);

    setStatus("loading editor‚Ä¶");
    const quill = new Quill("#editor", { theme:"snow", modules:{ toolbar:"#toolbar" } });
    document.getElementById("editor").addEventListener("pointerdown", () => { quill.focus(); hideOverlay(); }, {passive:true});

    const LS_CONTENT="wordmaker_content_v1";
    const LS_META="wordmaker_meta_v1";

    function saveLocal(){
      localStorage.setItem(LS_CONTENT, quill.root.innerHTML);
      localStorage.setItem(LS_META, JSON.stringify({
        title: $("docTitle").value || "Wordmaker document",
        header: $("headerText").value || "",
        footer: $("footerText").value || "",
        skin: $("skinSel").value || "bunny",
        savedAt: Date.now()
      }));
      setStatus("saved locally ‚úÖ");
    }
    function loadLocal(){
      const meta = localStorage.getItem(LS_META);
      const html = localStorage.getItem(LS_CONTENT);
      if (meta){
        try{
          const m = JSON.parse(meta);
          if (m.title) $("docTitle").value = m.title;
          if (m.header !== undefined) $("headerText").value = m.header;
          if (m.footer !== undefined) $("footerText").value = m.footer;
          if (m.skin) $("skinSel").value = m.skin;
        }catch{}
      }
      if (html) quill.root.innerHTML = html;
    }
    let saveT=null;
    quill.on("text-change", ()=>{ clearTimeout(saveT); saveT = setTimeout(()=>{ try{saveLocal();}catch{} }, 700); });

    $("btnSave").addEventListener("click", saveLocal);
    $("btnNew").addEventListener("click", ()=>{
      if (!confirm("Start a new document?")) return;
      $("docTitle").value = "Wordmaker document";
      quill.setContents([]);
      saveLocal();
      setStatus("new document ‚úÖ");
    });

    // Calculator UI
    const calcMenu = $("calcMenu");
    $("btnCalc").addEventListener("click", (e)=>{ e.stopPropagation(); calcMenu.style.display = (calcMenu.style.display==="block") ? "none" : "block"; });
    document.addEventListener("click", (e)=>{ if (!calcMenu.contains(e.target) && e.target !== $("btnCalc")) calcMenu.style.display="none"; });

    function safeEval(expr){
      if (!expr) return "";
      if (!/^[0-9\s\+\-\*\/\(\)\.^%]+$/.test(expr)) throw new Error("Only numbers and + - * / ( ) . ^ % allowed.");
      let e = expr.replace(/\^/g, "**").replace(/(\d+(?:\.\d+)?)%/g, "($1/100)");
      const v = Function('"use strict"; return ('+e+')')();
      if (typeof v !== "number" || !isFinite(v)) throw new Error("Invalid result.");
      return v;
    }
    ["7","8","9","/","4","5","6","*","1","2","3","-","0",".","(",")","+","^","%"].forEach(k=>{
      const b = document.createElement("button");
      b.textContent = k;
      b.addEventListener("click", ()=>{ $("calcDisplay").value += k; $("calcDisplay").focus(); });
      $("calcKeys").appendChild(b);
    });
    $("calcEval").addEventListener("click", ()=>{
      try{ $("calcOut").textContent = "Result: " + safeEval(($("calcDisplay").value||"").trim()); }
      catch(e){ $("calcOut").textContent = "Error: " + (e.message||e); }
    });
    $("calcClear").addEventListener("click", ()=>{ $("calcDisplay").value=""; $("calcOut").textContent=""; });
    $("calcBack").addEventListener("click", ()=>{ $("calcDisplay").value = ($("calcDisplay").value||"").slice(0,-1); });

    // Open-source AI Solve (fast+max)
    let webllmEngine=null, webllmLoading=false;
    let wllama=null, ggufLoaded=false, ggufLoading=false;
    const DEFAULT_GGUF_URL = "https://github.com/bradwillstep/Wordmaker/releases/download/v1/Qwen2.5-Math-7B-Instruct.Q4_K_M.gguf";

    async function ensureWebLLM(setOut){
      if (webllmEngine) return webllmEngine;
      if (webllmLoading){ while(!webllmEngine) await new Promise(r=>setTimeout(r,200)); return webllmEngine; }
      webllmLoading=true;
      setOut("Fast AI loading (downloads model)‚Ä¶");
      const mod = await import("https://esm.sh/@mlc-ai/web-llm@0.2.78");
      webllmEngine = await mod.CreateMLCEngine("Qwen2.5-Math-1.5B-Instruct-q4f16_1-MLC", {
        initProgressCallback:(rep)=>{ if (rep && rep.text) setOut("Fast AI loading‚Ä¶ "+rep.text); }
      });
      setOut("Fast AI ready ‚úÖ");
      return webllmEngine;
    }
    async function solveWebLLM(problem, setOut){
      const eng = await ensureWebLLM(setOut);
      setOut("Fast AI thinking‚Ä¶");
      const reply = await eng.chat.completions.create({ messages:[{role:"user", content:"Solve step-by-step then final answer:
"+problem+"

Steps:
Final answer:"}], temperature:0.1, max_tokens:768 });
      setOut(reply?.choices?.[0]?.message?.content?.trim() || "(No output)");
    }
    async function ensureWllama(){
      if (wllama) return wllama;
      const mod = await import("https://cdn.jsdelivr.net/npm/@wllama/wllama@2.3.7/+esm");
      wllama = new mod.Wllama();
      return wllama;
    }
    async function loadGGUF(url){
      if (!url) throw new Error("Paste a GGUF URL first.");
      if (ggufLoading) return;
      ggufLoading=true;
      $("ggufStatus").textContent = "Loading‚Ä¶";
      try{
        const wl = await ensureWllama();
        await wl.loadModelFromUrl(url, { progressCallback:(p)=>{ if (typeof p==="number") $("ggufStatus").textContent="Loading‚Ä¶ "+Math.round(p*100)+"%"; } });
        ggufLoaded=true;
        $("ggufStatus").textContent="Loaded ‚úÖ";
      } finally { ggufLoading=false; }
    }
    async function solveGGUF(problem, setOut){
      if (!ggufLoaded) throw new Error("Load the GGUF model first.");
      const wl = await ensureWllama();
      setOut("Max AI thinking‚Ä¶");
      const out = await wl.createCompletion("Solve step-by-step then final answer:
"+problem+"

Steps:
Final answer:", { temperature:0.1, maxTokens:512 });
      setOut((out||"").trim() || "(No output)");
    }
    function syncAiModeUI(){
      const mode = $("aiModeSelect").value;
      $("maxModeBox").style.display = (mode==="max") ? "block" : "none";
      if (mode==="max" && !$("ggufUrl").value) $("ggufUrl").value = DEFAULT_GGUF_URL;
    }
    $("aiModeSelect").addEventListener("change", syncAiModeUI);
    syncAiModeUI();
    $("btnLoadGGUF").addEventListener("click", async ()=>{
      try{ await loadGGUF(($("ggufUrl").value||"").trim()); }
      catch(e){ alert(e.message||e); $("ggufStatus").textContent="Load failed"; }
    });
    async function aiSolve(problem){
      const setOut = (t)=>{ $("calcOut").textContent = t; };
      try{
        if (($("aiModeSelect").value||"fast")==="fast") return await solveWebLLM(problem, setOut);
        return await solveGGUF(problem, setOut);
      }catch(e){
        setOut("AI Solve error: "+(e.message||e));
      }
    }
    $("calcAISolve").addEventListener("click", ()=>{
      const expr = ($("calcDisplay").value||"").trim();
      if (!expr) return alert("Type an expression first.");
      aiSolve(expr);
    });
    $("calcAISolve2").addEventListener("click", ()=>{
      const p = ($("calcProblem").value||"").trim();
      if (!p) return alert("Paste a problem first.");
      aiSolve(p);
    });

    // Page mode
    let pageMode=false;
    function buildPages(){
      const host = $("pagesHost");
      host.innerHTML = "";
      const text = quill.getText();
      const per = 2200;
      let page = 1;
      for (let i=0; i<text.length; i+=per){
        const chunk = text.slice(i, i+per).trim();
        const div = document.createElement("div");
        div.style.background = "rgba(255,255,255,.03)";
        div.style.border = "1px solid rgba(255,255,255,.14)";
        div.style.borderRadius = "14px";
        div.style.boxShadow = "0 18px 50px rgba(0,0,0,.45)";
        div.style.padding = "22px 20px";
        div.style.minHeight = "1120px";
        div.style.margin = "0 auto 14px";
        div.innerHTML = "<div style='opacity:.65;font-size:11px;float:right'>Page "+page+"</div><div style='white-space:pre-wrap'>"+chunk.replace(/[&<>]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]))+"</div>";
        host.appendChild(div);
        page++;
      }
    }
    $("btnPageMode").addEventListener("click", ()=>{
      pageMode = !pageMode;
      $("btnPageMode").textContent = "Page Mode: " + (pageMode ? "ON" : "OFF");
      $("pagesHost").style.display = pageMode ? "block" : "none";
      document.getElementById("editor").style.display = pageMode ? "none" : "block";
      if (pageMode) buildPages();
    });
    quill.on("text-change", ()=>{ if (pageMode) buildPages(); });

    // Open/import
    async function readFileAsArrayBuffer(file){
      return await new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload=()=>resolve(r.result);
        r.onerror=()=>reject(r.error);
        r.readAsArrayBuffer(file);
      });
    }
    async function openFile(file){
      const name = file.name || "document";
      const ext = (name.split(".").pop() || "").toLowerCase();
      if (ext==="docx"){
        setStatus("opening DOCX‚Ä¶");
        const ab = await readFileAsArrayBuffer(file);
        const res = await window.mammoth.convertToHtml({ arrayBuffer: ab });
        quill.root.innerHTML = res.value || "<p><br></p>";
        setStatus("opened DOCX ‚úÖ");
        return;
      }
      if (ext==="pdf"){
        setStatus("opening PDF (text layer)‚Ä¶");
        const ab = await readFileAsArrayBuffer(file);
        const pdf = await pdfjsLib.getDocument({data: ab}).promise;
        let fullText = "";
        for (let p=1; p<=pdf.numPages; p++){
          setStatus("extracting PDF text‚Ä¶ page "+p+"/"+pdf.numPages);
          const page = await pdf.getPage(p);
          const tc = await page.getTextContent();
          const pageText = (tc.items||[]).map(it=>it.str).join(" ").replace(/\s+/g," ").trim();
          fullText += "

--- Page "+p+" ---
" + pageText;
        }
        if (fullText.replace(/\s/g,"").length > 80){
          quill.setText(fullText.trim()+ "
");
          setStatus("opened PDF text ‚úÖ");
          return;
        }
        const doOcr = confirm("This PDF looks like a scan (no text). Run OCR? (slow on mobile)");
        if (!doOcr){
          quill.setText("PDF has no selectable text. Try OCR on desktop.
");
          setStatus("opened PDF (no text) ‚ö†Ô∏è");
          return;
        }
        setStatus("OCR starting‚Ä¶");
        const worker = await Tesseract.createWorker("eng");
        let ocrText = "";
        for (let p=1; p<=pdf.numPages; p++){
          setStatus("OCR‚Ä¶ page "+p+"/"+pdf.numPages);
          const page = await pdf.getPage(p);
          const viewport = page.getViewport({scale: 2.0});
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          canvas.width = viewport.width;
          canvas.height = viewport.height;
          await page.render({canvasContext: ctx, viewport}).promise;
          const rec = await worker.recognize(canvas);
          ocrText += "

--- Page "+p+" ---
" + (rec.data && rec.data.text ? rec.data.text : "");
        }
        await worker.terminate();
        quill.setText((ocrText||"OCR produced no text.") + "
");
        setStatus("opened PDF via OCR ‚úÖ");
        return;
      }
      if (ext==="odt"){
        setStatus("opening ODT‚Ä¶");
        const ab = await readFileAsArrayBuffer(file);
        const files = window.fflate.unzipSync(new Uint8Array(ab));
        const contentXml = files["content.xml"];
        if (!contentXml) throw new Error("ODT missing content.xml");
        const xmlStr = new TextDecoder("utf-8").decode(contentXml);
        const paras = [];
        const reP = /<(text:p|text:h)[^>]*>([\s\S]*?)<\/>/g;
        let m;
        while ((m = reP.exec(xmlStr)) !== null){
          const inner = m[2].replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim();
          if (inner) paras.push(inner);
        }
        quill.setText(paras.join("

") + "
");
        setStatus("opened ODT ‚úÖ");
        return;
      }
      if (ext==="pages"){
        setStatus("opening Pages‚Ä¶");
        const ab = await readFileAsArrayBuffer(file);
        const files = window.fflate.unzipSync(new Uint8Array(ab));
        let idx = files["index.xml"] || files["index.xml.gz"];
        if (!idx){
          const key = Object.keys(files).find(k => k.toLowerCase().endsWith("index.xml") || k.toLowerCase().endsWith("index.xml.gz"));
          if (key) idx = files[key];
        }
        if (!idx) throw new Error("Pages missing index.xml");
        let xmlU8 = idx;
        if (xmlU8[0]===0x1f && xmlU8[1]===0x8b) xmlU8 = window.fflate.gunzipSync(xmlU8);
        const xmlStr = new TextDecoder("utf-8").decode(xmlU8);
        const text = xmlStr.replace(/<[^>]+>/g,"
").replace(/
{3,}/g,"

").trim();
        quill.setText((text||"No text found.") + "
");
        setStatus("opened Pages ‚úÖ");
        return;
      }
      if (ext==="rtf"){
        setStatus("opening RTF‚Ä¶");
        const t = await file.text();
        const stripped = t.replace(/\{\*\[^}]*\}/g,"").replace(/\'[0-9a-fA-F]{2}/g,"").replace(/\[a-zA-Z]+-?\d* ?/g,"").replace(/[{}]/g,"").replace(/
/g,"
");
        quill.setText(stripped.trim()+"
");
        setStatus("opened RTF ‚úÖ");
        return;
      }
      if (ext==="txt"){
        quill.setText(await file.text());
        setStatus("opened TXT ‚úÖ");
        return;
      }
      if (ext==="doc"){
        alert("Legacy .doc cannot be reliably imported in a browser-only app. Convert to .docx first.");
        setStatus("DOC not supported");
        return;
      }
      // html fallback
      const t = await file.text();
      const bodyMatch = t.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
      quill.root.innerHTML = (bodyMatch ? bodyMatch[1] : t) || "<p><br></p>";
      setStatus("opened ‚úÖ");
    }

    $("btnOpen").addEventListener("click", ()=> $("fileOpen").click());
    $("fileOpen").addEventListener("change", async ()=>{
      const f = $("fileOpen").files && $("fileOpen").files[0];
      if (!f) return;
      try{ await openFile(f); saveLocal(); } catch(e){ alert(e.message||e); setStatus("open failed"); }
      finally{ $("fileOpen").value=""; }
    });

    // Export helpers
    function wrapAsHtmlDoc(bodyHtml, title) {
      const hdrTxt = ($("headerText").value || "").trim();
      const ftrTxt = ($("footerText").value || "").trim();
      return "<!doctype html><html><head><meta charset='utf-8'><title>"+escapeHtml(title)+"</title>"
        + "<style>@page{margin:0.9in}body{font-family:Calibri,Arial,sans-serif;font-size:12pt;line-height:1.35;margin:0;background:#fff;color:#000}"
        + ".wrap{max-width:7.5in;margin:0 auto}.hdr{margin:0 0 14px 0;padding-bottom:10px;border-bottom:1px solid #ddd}"
        + ".ftr{margin:14px 0 0 0;padding-top:10px;border-top:1px solid #ddd}img{max-width:100%}</style></head><body><div class='wrap'>"
        + (hdrTxt ? "<div class='hdr'>"+escapeHtml(hdrTxt)+"</div>" : "")
        + "<div class='body'>"+bodyHtml+"</div>"
        + (ftrTxt ? "<div class='ftr'>"+escapeHtml(ftrTxt)+"</div>" : "")
        + "</div></body></html>";
    }
    $("btnPrint").addEventListener("click", ()=>{
      const w = window.open("", "_blank");
      w.document.open();
      w.document.write(wrapAsHtmlDoc(quill.root.innerHTML, $("docTitle").value||"Wordmaker"));
      w.document.close();
      w.focus();
      w.print();
    });
    $("btnDocx").addEventListener("click", ()=>{
      const title = $("docTitle").value||"Wordmaker";
      const docxBlob = window.htmlDocx.asBlob(wrapAsHtmlDoc(quill.root.innerHTML, title));
      downloadBlob(docxBlob, safeFilename(title)+".docx");
      setStatus("exported DOCX ‚úÖ");
    });
    $("btnPdf").addEventListener("click", async ()=>{
      const title = $("docTitle").value||"Wordmaker";
      const container = document.createElement("div");
      container.innerHTML = wrapAsHtmlDoc(quill.root.innerHTML, title);
      const body = container.querySelector("body");
      const page = document.createElement("div");
      page.style.background="#fff"; page.style.color="#000";
      page.append(...Array.from(body.children));
      setStatus("exporting PDF‚Ä¶");
      await html2pdf().set({ margin:0, filename:safeFilename(title)+".pdf", html2canvas:{scale:2,useCORS:true}, jsPDF:{unit:"pt", format:"letter", orientation:"portrait"} }).from(page).save();
      setStatus("exported PDF ‚úÖ");
    });

    // Tools drawer (embed + grammar only here)
    const drawerBack = $("drawerBack"), drawer = $("drawer");
    $("btnTools").addEventListener("click", ()=>{ drawerBack.style.display="block"; drawer.style.display="block"; });
    $("btnCloseTools").addEventListener("click", ()=>{ drawerBack.style.display="none"; drawer.style.display="none"; });
    drawerBack.addEventListener("click", ()=>{ drawerBack.style.display="none"; drawer.style.display="none"; });

    const EMBED_URL = "https://huggingface.co/spaces/Timemaster/grammar-fixer";
    $("embedFrame").src = EMBED_URL;
    $("btnOpenEmbed").addEventListener("click", ()=>window.open(EMBED_URL, "_blank", "noopener,noreferrer"));
    $("btnCopySelection").addEventListener("click", async ()=>{
      const r = quill.getSelection();
      if (!r || r.length===0) return alert("Select text first.");
      await navigator.clipboard.writeText(quill.getText(r.index, r.length));
      setStatus("copied ‚úÖ");
    });
    $("btnCopyAll").addEventListener("click", async ()=>{
      await navigator.clipboard.writeText(quill.getText());
      setStatus("copied ‚úÖ");
    });
    $("btnReplaceWithEmbed").addEventListener("click", ()=>{
      const t = ($("embedResult").value||"").trim();
      if (!t) return alert("Paste output first.");
      const r = quill.getSelection(true);
      if (!r || r.length===0) return alert("Select text first.");
      quill.deleteText(r.index, r.length, "user");
      quill.insertText(r.index, t, "user");
      saveLocal();
    });
    $("btnInsertEmbed").addEventListener("click", ()=>{
      const t = ($("embedResult").value||"").trim();
      if (!t) return alert("Paste output first.");
      const r = quill.getSelection(true) || {index: quill.getLength(), length:0};
      quill.insertText(r.index, t, "user");
      saveLocal();
    });

    const LT_URL = "https://api.languagetool.org/v2/check";
    $("btnClearIssues").addEventListener("click", ()=> $("issues").innerHTML="");
    $("btnGrammar").addEventListener("click", async ()=>{
      try{
        $("issues").innerHTML="";
        const t = quill.getText().trim();
        if (!t) { $("issues").innerHTML="<div class='small'>Nothing to check.</div>"; return; }
        setStatus("grammar checking‚Ä¶");
        const form = new URLSearchParams();
        form.set("text", t);
        form.set("language", "auto");
        const resp = await fetch(LT_URL, { method:"POST", headers:{ "Content-Type":"application/x-www-form-urlencoded" }, body: form.toString() });
        if (!resp.ok) throw new Error("LanguageTool HTTP "+resp.status);
        const data = await resp.json();
        const matches = data.matches || [];
        if (!matches.length){ $("issues").innerHTML="<div class='small'>No issues found ‚úÖ</div>"; setStatus("grammar: clean ‚úÖ"); return; }
        setStatus("grammar: found "+matches.length);
        matches.slice(0,20).forEach(m=>{
          const div = document.createElement("div");
          div.className="section";
          div.innerHTML = "<div class='small'><b>"+escapeHtml(m.shortMessage||"Grammar")+"</b></div><div class='small'>"+escapeHtml(m.message||"")+"</div>";
          $("issues").appendChild(div);
        });
      }catch(e){
        alert(e.message||e);
        setStatus("grammar error");
      }
    });

    // PWA install prompt
    const fab = $("installFab");
    let deferred = null;
    window.addEventListener("beforeinstallprompt", (e)=>{
      e.preventDefault();
      deferred = e;
      fab.style.display = "flex";
    });
    window.addEventListener("appinstalled", ()=>{ deferred=null; fab.style.display="none"; });
    fab.addEventListener("click", async ()=>{
      if (deferred){
        deferred.prompt();
        try{ await deferred.userChoice; }catch{}
        deferred=null;
      } else {
        alert("To install Wordmaker: Chrome menu (‚ãÆ) ‚Üí Install app / Add to Home screen.");
      }
    });

    // Init
    loadLocal();
    updateHeaderH();
    setTimeout(updateHeaderH, 80);
    setStatus("ready ‚úÖ ‚Äî tap the page to type");
  </script>
</body>
</html>
